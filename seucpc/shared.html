<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>åˆ†äº«ç»“æœæŸ¥çœ‹ â€” è™šå¯æ–‡å®¶é•¿ç¾¤ æ•™ç»ƒæ¨¡æ‹Ÿå™¨</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .shared-banner {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      text-align: center;
    }
    
    .shared-banner h2 {
      margin: 0 0 8px 0;
      font-size: 24px;
    }
    
    .shared-banner p {
      margin: 0;
      opacity: 0.9;
      font-size: 14px;
    }

    .ending-highlight {
      color: #1976d2;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    
    .ending-animate {
      animation: pulse 2s ease-in-out;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.8; }
    }
    
    #shared-summary h4 {
      margin: 0 0 8px 0;
      color: #333;
      font-size: 16px;
    }
    
    #shared-summary table {
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    #shared-summary table th {
      background: #f5f5f5 !important;
    }

    .error-message {
      background: #ffebee;
      color: #c62828;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      border: 1px solid #ef5350;
    }

    .error-message h3 {
      margin: 0 0 12px 0;
    }
  </style>
  <!-- Cloudflare Web Analytics loader (conditional: only load if page load time <= 2s) -->
  <script>
    (function(){
      function injectCF(){
        var s = document.createElement('script');
        s.defer = true;
        s.src = 'https://static.cloudflareinsights.com/beacon.min.js';
        s.setAttribute('data-cf-beacon', '{"token": "cd3db41765ea4c17be0930b3f94e3c3a"}');
        document.head.appendChild(s);
      }
      function shouldLoad(){
        try{
          var start = (performance.timing && performance.timing.navigationStart) || 0;
          var elapsed = performance.now ? performance.now() : (Date.now() - start);
          return elapsed <= 2000;
        }catch(e){ return false; }
      }
      document.addEventListener('DOMContentLoaded', function(){ if(shouldLoad()) injectCF(); });
    })();
  </script>
</head>
<body>
<div class="container">
  <header>
    <h1>ğŸ”— åˆ†äº«ç»“æœæŸ¥çœ‹</h1>
  </header>
  
  <div id="shared-banner" class="shared-banner" style="display:none;">
    <h2>ğŸ‘€ æŸ¥çœ‹ä»–äººçš„æ¸¸æˆç»“æœ</h2>
    <p>ä»¥ä¸‹æ˜¯åˆ†äº«è€…çš„æ¸¸æˆç»“ç®—æ•°æ®</p>
  </div>

  <div class="panel" id="shared-panel">
    <div id="shared-summary" class="small muted">æ­£åœ¨åŠ è½½åˆ†äº«æ•°æ®â€¦â€¦</div>
    <div class="modal-actions" style="margin-top:16px">
      <button class="btn btn-ghost" id="shared-back">å›åˆ°å¼€å§‹</button>
      <button class="btn" id="shared-play">æˆ‘ä¹Ÿæ¥ç©</button>
    </div>
  </div>
</div>

<script src="lib/constants.js"></script>
<script src="lib/utils.js"></script>
<script src="lib/models.js"></script>
<script src="lib/talent.js"></script>
<script src="lib/share.js"></script>
<script src="game.js"></script>
<script src="render.js"></script>
<script src="debug.js"></script>
<script>
  // é¡µé¢åŠ è½½åç«‹å³è§£æåˆ†äº«æ•°æ®
  document.addEventListener('DOMContentLoaded', function() {
    renderSharedSummary();
  });

  document.getElementById('shared-back').onclick = () => { 
    window.location.href = 'start.html'; 
  };
  
  document.getElementById('shared-play').onclick = () => { 
    window.location.href = 'start.html'; 
  };

  /**
   * æ¸²æŸ“åˆ†äº«çš„ç»“ç®—æ•°æ®
   */
  function renderSharedSummary() {
    const el = document.getElementById('shared-summary');
    const banner = document.getElementById('shared-banner');
    
    if (!el) return;

    try {
      // ä½¿ç”¨ ShareManager è§£æURLä¸­çš„æ•°æ®
      const sharedData = ShareManager.parseSharedData();
      
      if (!sharedData || !sharedData.gameState) {
        throw new Error('æ— æ•ˆçš„åˆ†äº«é“¾æ¥æˆ–æ•°æ®å·²æŸå');
      }

      // æ˜¾ç¤ºæ¨ªå¹…
      if (banner) banner.style.display = 'block';

      const o = sharedData.gameState;
      
      // åŸºæœ¬ä¿¡æ¯
      const active = (o.students || []).filter(s => s && s.active !== false).length;
      const initial = o.initial_students || (o.students ? o.students.length : 0);
      const rep = o.reputation || 0;
      const budget = o.budget || 0;
      const totalExpenses = o.totalExpenses || 0;
      const week = o.week || 0;
      
      // è®¡ç®—å¹³å‡å‹åŠ›
      let avgP = 0;
      if (o.students && o.students.length > 0) {
        avgP = Math.round(o.students.filter(s => s && s.active !== false).reduce((a, s) => a + (s.pressure || 0), 0) / Math.max(1, active));
      }
      
      // è§„èŒƒåŒ–ç»“æŸåŸå› 
      const endingReason = typeof normalizeEndingReason === 'function' 
        ? normalizeEndingReason(o.endingReason || 'èµ›å­£ç»“æŸ')
        : (o.endingReason || 'èµ›å­£ç»“æŸ');
      
      // æ„å»ºå­¦ç”Ÿè¯¦ç»†ä¿¡æ¯
      let studentsHtml = '';
      if (o.students && o.students.length > 0) {
        studentsHtml += `<div style="margin-top:12px"><h4>ğŸ‘¥ å­¦ç”Ÿè¯¦ç»†ä¿¡æ¯</h4></div>`;
        studentsHtml += `<div style="max-height:260px;overflow:auto;border:1px solid #ddd;border-radius:4px;padding:8px;background:#fafafa">`;
        
        for (let s of o.students) {
          const isActive = (s && s.active !== false);
          const pressureLevel = (s && typeof s.pressure === 'number') ? (s.pressure < 35 ? 'ä½' : s.pressure < 65 ? 'ä¸­' : 'é«˜') : 'â€”';
          const pressureClass = (s && typeof s.pressure === 'number') ? (s.pressure < 35 ? 'pressure-low' : s.pressure < 65 ? 'pressure-mid' : 'pressure-high') : '';
          const thinkingVal = Number(s.thinking || 0);
          const codingVal = Number(s.coding || 0);
          const mentalVal = Number(s.mental || 0);
          const thinkGrade = typeof getLetterGradeAbility === 'function' ? getLetterGradeAbility(Math.floor(thinkingVal)) : Math.floor(thinkingVal);
          const codeGrade = typeof getLetterGradeAbility === 'function' ? getLetterGradeAbility(Math.floor(codingVal)) : Math.floor(codingVal);
          const mentalRounded = Math.round(mentalVal || 0);
          
          // çŸ¥è¯†å„ç»´åº¦
          const k_ds = typeof getLetterGrade === 'function' ? getLetterGrade(Math.floor(Number(s.knowledge_ds || 0))) : Math.floor(Number(s.knowledge_ds || 0));
          const k_graph = typeof getLetterGrade === 'function' ? getLetterGrade(Math.floor(Number(s.knowledge_graph || 0))) : Math.floor(Number(s.knowledge_graph || 0));
          const k_str = typeof getLetterGrade === 'function' ? getLetterGrade(Math.floor(Number(s.knowledge_string || 0))) : Math.floor(Number(s.knowledge_string || 0));
          const k_math = typeof getLetterGrade === 'function' ? getLetterGrade(Math.floor(Number(s.knowledge_math || 0))) : Math.floor(Number(s.knowledge_math || 0));
          const k_dp = typeof getLetterGrade === 'function' ? getLetterGrade(Math.floor(Number(s.knowledge_dp || 0))) : Math.floor(Number(s.knowledge_dp || 0));
          
          // å¤©èµ‹æ˜¾ç¤º
          let talentsHtml = '';
          try {
            if (s.talents && Array.isArray(s.talents)) {
              talentsHtml = s.talents.map(tn => {
                const info = (window.TalentManager && typeof window.TalentManager.getTalentInfo === 'function') 
                  ? window.TalentManager.getTalentInfo(tn) 
                  : { name: tn, description: '', color: '#2b6cb0' };
                return `<span class="talent-tag" data-talent="${tn}" style="background-color:${info.color}20;color:${info.color};border-color:${info.color}40;margin-right:6px;">${tn}<span class="talent-tooltip">${info.description || ''}</span></span>`;
              }).join('');
            }
          } catch (e) { 
            talentsHtml = ''; 
          }

          studentsHtml += `<div class="student-box" style="margin-bottom:8px;padding:8px;background:white;border-radius:6px;border:1px solid #eee">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><strong>${s.name}</strong> ${isActive ? '' : '<span class="warn">[é€€é˜Ÿ]</span>'} <span class="label-pill ${pressureClass}" style="margin-left:8px">å‹åŠ›:${pressureLevel}</span></div>
              <div style="font-size:12px;color:#666">å¿ƒç†:${mentalRounded}</div>
            </div>
            <div class="compact small" style="margin-top:6px">
              èƒ½åŠ›: æ€ç»´:${thinkGrade} ç¼–ç :${codeGrade}
              <div style="margin-top:6px">çŸ¥è¯†: <span class="knowledge-badges">
                <span class="kb" title="æ•°æ®ç»“æ„: ${Math.floor(Number(s.knowledge_ds || 0))}">æ•°æ®ç»“æ„${k_ds}</span>
                <span class="kb" title="å›¾è®º: ${Math.floor(Number(s.knowledge_graph || 0))}">å›¾è®º${k_graph}</span>
                <span class="kb" title="å­—ç¬¦ä¸²: ${Math.floor(Number(s.knowledge_string || 0))}">å­—ç¬¦ä¸²${k_str}</span>
                <span class="kb" title="æ•°å­¦: ${Math.floor(Number(s.knowledge_math || 0))}">æ•°å­¦${k_math}</span>
                <span class="kb" title="åŠ¨æ€è§„åˆ’: ${Math.floor(Number(s.knowledge_dp || 0))}">åŠ¨æ€è§„åˆ’${k_dp}</span>
              </span></div>
            </div>
            ${talentsHtml ? `<div class="student-talents" style="margin-top:8px">${talentsHtml}</div>` : ''}
          </div>`;
        }
        studentsHtml += `</div>`;
      }
      
      // æ„å»ºæ¯”èµ›ç”Ÿæ¶¯è®°å½•
      let careerHtml = '';
      const career = o.careerCompetitions;
      if (career && Array.isArray(career) && career.length > 0) {
        careerHtml += `<div style="margin-top:12px"><h4>ğŸ“Š æ¯”èµ›ç”Ÿæ¶¯è®°å½•</h4></div>`;
        careerHtml += `<div style="margin-top:8px;max-height:300px;overflow:auto;border:1px solid #ddd;border-radius:4px;padding:8px;background:#fafafa">`;
        
        for (let rec of career) {
          const passedCount = rec.passedCount || 0;
          const totalStudents = rec.totalStudents || 0;
          const passRate = totalStudents > 0 ? ((passedCount / totalStudents) * 100).toFixed(0) : '0';
          
          careerHtml += `<div style="margin-bottom:12px;padding:8px;background:white;border-radius:4px;border-left:3px solid #4a90e2">`;
          careerHtml += `<div style="font-weight:bold;margin-bottom:4px">ç¬¬ ${rec.week} å‘¨ - ${rec.name}</div>`;
          careerHtml += `<div style="font-size:13px;color:#666;margin-bottom:6px">æ™‹çº§ï¼š${passedCount}/${totalStudents} äºº (${passRate}%)</div>`;
          
          if (rec.entries && rec.entries.length > 0) {
            careerHtml += `<table style="width:100%;font-size:12px;border-collapse:collapse">`;
            careerHtml += `<thead><tr style="background:#f0f0f0">
              <th style="padding:4px;text-align:left">å­¦ç”Ÿ</th>
              <th style="padding:4px;text-align:center">æ’å</th>
              <th style="padding:4px;text-align:center">åˆ†æ•°</th>
              <th style="padding:4px;text-align:left">ç»“æœ</th>
            </tr></thead><tbody>`;
            
            for (let e of rec.entries) {
              const rankText = e.rank ? `#${e.rank}` : (e.eligible === false ? '-' : 'â€”');
              const scoreText = (e.total != null && e.total !== undefined) ? (e.total.toFixed ? e.total.toFixed(1) : e.total) : 
                               (e.score != null && e.score !== undefined) ? (e.score.toFixed ? e.score.toFixed(1) : e.score) : 'â€”';
              const passedIcon = e.passed ? 'âœ“' : (e.eligible === false ? '' : 'âœ—');
              const passedStyle = e.passed ? 'color:green;font-weight:bold' : (e.eligible === false ? 'color:#999' : 'color:#d32f2f');
              let remarkText = e.remark || '';
              if (!remarkText) {
                if (e.eligible === false) remarkText = 'æœªå‚åŠ ';
                else if (e.passed) remarkText = 'æ™‹çº§';
                else if (e.medal) remarkText = e.medal === 'gold' ? 'é‡‘ç‰Œ' : e.medal === 'silver' ? 'é“¶ç‰Œ' : e.medal === 'bronze' ? 'é“œç‰Œ' : '';
              }
              
              careerHtml += `<tr style="border-bottom:1px solid #eee">`;
              careerHtml += `<td style="padding:4px">${e.name}</td>`;
              careerHtml += `<td style="padding:4px;text-align:center">${rankText}</td>`;
              careerHtml += `<td style="padding:4px;text-align:center">${scoreText}</td>`;
              careerHtml += `<td style="padding:4px;${passedStyle}">${passedIcon} ${remarkText}</td>`;
              careerHtml += `</tr>`;
            }
            
            careerHtml += `</tbody></table>`;
          }
          careerHtml += `</div>`;
        }
        
        careerHtml += `</div>`;
      } else {
        careerHtml += `<div class="small muted" style="margin-top:8px">æœªè®°å½•åˆ°æ¯”èµ›ç”Ÿæ¶¯æ•°æ®</div>`;
      }

      // æ„å»ºæ—¶é—´è½´è¿›åº¦æ¡
      let timelineHtml = '';
      if (week > 0) {
        timelineHtml += `<div style="margin-top:12px"><h4>ğŸ“… æ—¶é—´è½´è¿›åº¦</h4></div>`;
        timelineHtml += `<div style="margin-top:8px;padding:12px;background:#f9f9f9;border-radius:8px">`;
        
        const competitions = (typeof window !== 'undefined' && Array.isArray(window.competitions) && window.competitions.length > 0)
          ? window.competitions.slice().sort((a, b) => a.week - b.week)
          : [
            { name: 'CSP-S1', week: 6 }, { name: 'CSP-S2', week: 10 }, { name: 'NOIP', week: 14 },
            { name: 'çœé€‰', week: 18 }, { name: 'NOI', week: 22 }, { name: 'CSP-S1', week: 26 },
            { name: 'CSP-S2', week: 30 }, { name: 'NOIP', week: 34 }, { name: 'çœé€‰', week: 38 },
            { name: 'NOI', week: 42 }
          ];

        const lastCompWeek = competitions.length ? Math.max(...competitions.map(c => Number(c.week) || 0)) : 0;
        const maxWeeks = Math.max(week, lastCompWeek, typeof SEASON_WEEKS !== 'undefined' ? SEASON_WEEKS : 40);
        const progressPercent = Math.min(100, (week / maxWeeks) * 100);
        
        timelineHtml += `<div style="position:relative;height:20px;background:#e0e0e0;border-radius:10px;margin-bottom:12px">`;
        timelineHtml += `<div style="height:100%;background:linear-gradient(90deg, #4caf50, #2196f3);border-radius:10px;width:${progressPercent}%" title="è¿›åº¦ï¼šç¬¬${week}å‘¨"></div>`;
        timelineHtml += `<div style="position:absolute;top:50%;left:8px;transform:translateY(-50%);color:white;font-size:12px;font-weight:bold">ç¬¬ ${week} å‘¨</div>`;
        timelineHtml += `</div>`;
        
        timelineHtml += `<div style="position:relative;height:30px">`;
        for (let comp of competitions) {
          const position = (comp.week / maxWeeks) * 100;
          const isPast = comp.week <= week;
          const pinColor = isPast ? '#4caf50' : '#ffc107';
          const pinIcon = isPast ? 'âœ“' : 'ğŸ“';
          
          timelineHtml += `<div style="position:absolute;left:${position}%;transform:translateX(-50%);top:0">`;
          timelineHtml += `<div style="width:20px;height:20px;background:${pinColor};border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;color:white;border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.2)" title="${comp.name} - ç¬¬${comp.week}å‘¨">${pinIcon}</div>`;
          timelineHtml += `<div style="position:absolute;top:22px;left:50%;transform:translateX(-50%);font-size:10px;white-space:nowrap;color:#666">${comp.name}</div>`;
          timelineHtml += `</div>`;
        }
        timelineHtml += `</div></div>`;
      }
      
      // æ¸²æŸ“å®Œæ•´ä¿¡æ¯
      el.innerHTML = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
          <div>
            <h4>ğŸ“ˆ åŸºæœ¬ä¿¡æ¯</h4>
            <div style="background:#f9f9f9;padding:12px;border-radius:8px">
              <div>åˆå§‹äººæ•°: <strong>${initial}</strong></div>
              <div>å½“å‰åœ¨é˜Ÿ: <strong>${active}</strong></div>
              <div>å¹³å‡å‹åŠ›: <strong>${avgP}</strong></div>
              <div>å£°èª‰: <strong>${rep}</strong></div>
              <div>è¿›è¡Œåˆ°ç¬¬: <strong>${week}</strong> å‘¨</div>
            </div>
          </div>
          <div>
            <h4>ğŸ’° è´¢åŠ¡çŠ¶å†µ</h4>
            <div style="background:#f9f9f9;padding:12px;border-radius:8px">
              <div>å½“å‰é‡‘é¢: <strong>Â¥${budget.toLocaleString()}</strong></div>
              <div>ç´¯è®¡æ¶ˆè´¹: <strong>Â¥${totalExpenses.toLocaleString()}</strong></div>
              <div>ç»“æŸåŸå› : <strong>${endingReason}</strong></div>
            </div>
          </div>
        </div>
        ${timelineHtml}
        ${studentsHtml}
        ${careerHtml}
        <div id="ending-result" style="margin-top:16px;padding:16px;background:#e3f2fd;border-radius:8px;text-align:center">
          <div style="font-size:18px;font-weight:bold;margin-bottom:8px">æœ€ç»ˆç»“å±€</div>
          <div id="ending-text" class="ending-highlight" style="font-size:24px;font-weight:bold">
            æ­£åœ¨è®¡ç®—ç»“å±€...
          </div>
        </div>
      `;
      
      // è®¡ç®—å¹¶æ˜¾ç¤ºæœ€ç»ˆç»“å±€
      setTimeout(() => {
        const finalEnding = typeof calculateFinalEnding === 'function' 
          ? calculateFinalEnding(o, endingReason)
          : 'ğŸ’¼ æ™®é€šç»“å±€';
        const endingEl = document.getElementById('ending-text');
        const container = document.getElementById('ending-result');
        const descText = typeof mapEndingToDescription === 'function'
          ? mapEndingToDescription(finalEnding)
          : '';
          
        if (endingEl) {
          endingEl.textContent = finalEnding;
          endingEl.classList.add('ending-animate');
          setTimeout(() => endingEl.classList.remove('ending-animate'), 2500);
        }
        
        if (container && descText) {
          let descEl = document.getElementById('ending-desc');
          if (!descEl) {
            descEl = document.createElement('div');
            descEl.id = 'ending-desc';
            descEl.style.cssText = 'margin-top:8px;color:#0d47a1;font-size:14px;line-height:1.4;';
            descEl.className = 'small muted';
            container.appendChild(descEl);
          }
          descEl.textContent = descText;
        }
      }, 500);
      
    } catch (e) {
      el.innerHTML = `
        <div class="error-message">
          <h3>âš ï¸ åŠ è½½å¤±è´¥</h3>
          <p>${e.message}</p>
          <p style="margin-top:12px;font-size:13px;opacity:0.8;">è¯·ç¡®ä¿é“¾æ¥å®Œæ•´ä¸”æœªè¢«ä¿®æ”¹</p>
        </div>
      `;
      console.error('renderSharedSummary error:', e);
      if (banner) banner.style.display = 'none';
    }
  }
</script>
<footer style="text-align:center;padding:12px 8px;color:#666;font-size:13px;border-top:1px solid #eee;margin-top:18px">
  ä½œè€… @Dreamers-seve Â· æ´›è°·: <a href="https://www.luogu.com.cn/user/668972" target="_blank" rel="noopener">https://www.luogu.com.cn/user/668972</a> Â· GitHub: <a href="https://github.com/seve42/OItrainer" target="_blank" rel="noopener">https://github.com/seve42/OItrainer</a>
</footer>
  <!-- winter plan injection: center link inside footer (or fixed bottom if no footer) -->
  <script>
    (function(){
      try{
        var cutoff = new Date('2026-03-01T00:00:00Z');
        var now = new Date();
        if(now >= cutoff) return;
        var footer = document.querySelector('footer');
        var linkHtml = '<a href="https://www.luogu.me/article/n4gmkam0" target="_blank" rel="noopener" style="color:#1976d2;text-decoration:none;font-weight:600;padding:6px 10px;border-radius:6px">å†¬æ—¥ç»˜æ¿è®¡åˆ’</a>';
        var container;
        if(footer){
          container = footer.querySelector('#winter-plan');
          if(!container){
            container = document.createElement('div');
            container.id = 'winter-plan';
            container.style.marginTop = '8px';
            container.style.fontSize = '13px';
            container.style.color = '#1976d2';
            container.style.textAlign = 'center';
            footer.appendChild(container);
          }
        } else {
          container = document.getElementById('winter-plan');
          if(!container){
            container = document.createElement('div');
            container.id = 'winter-plan';
            container.style.position = 'fixed';
            container.style.left = '0';
            container.style.right = '0';
            container.style.bottom = '8px';
            container.style.textAlign = 'center';
            container.style.fontSize = '13px';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
          }
        }
        container.innerHTML = linkHtml;
      }catch(e){}
    })();
  </script>
</body>
</html>
